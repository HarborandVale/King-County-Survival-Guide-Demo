<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>King County Survival Guide – Harbor &amp; Vale LLC (Demo)</title>
  <style>
    /* Vaporwave palette — brighter accents */
    :root {
      --brand-bg-1: #0b0c1e;
      --brand-bg-2: #1a1540;
      --brand-card: rgba(255,255,255,0.06);
      --brand-border: rgba(255,255,255,0.12);
      --brand-text: #f2f2f7;
      --brand-muted: #b8b8d9;
      --brand-primary: #9b6bff;
      --brand-accent: #ff71ce;
      --brand-cyan: #01cdfe;
      --shadow: 0 8px 28px rgba(0,0,0,.35);
    }

    html, body { height: 100%; }
    body{
      font-family: system-ui, Arial, sans-serif;
      color: var(--brand-text);
      background: radial-gradient(1200px 800px at 20% -10%, #2a1b59 0%, transparent 60%),
                  radial-gradient(1000px 700px at 120% 20%, #0b3d91 0%, transparent 55%),
                  linear-gradient(180deg, var(--brand-bg-1) 0%, var(--brand-bg-2) 100%);
      max-width: 900px;
      margin: 24px auto;
      padding: 0 16px;
      line-height: 1.5;
    }

    h1, h2, h3 { color: var(--brand-text); }
    .muted{ color: var(--brand-muted); margin:0; }

    .pill{
      font-size:12px;
      border:1px solid var(--brand-border);
      border-radius:999px;
      padding:4px 10px;
      color: var(--brand-muted);
      background: var(--brand-card);
      backdrop-filter: blur(6px);
    }

    .card{
      border:1px solid var(--brand-border);
      border-radius:14px;
      padding:16px;
      margin:12px 0;
      background: var(--brand-card);
      box-shadow: var(--shadow);
    }

    button{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--brand-border);
      cursor:pointer;
      background: linear-gradient(135deg, var(--brand-accent), var(--brand-cyan));
      color:#0b0c1e;
      font-weight:600;
      white-space: nowrap;
    }
    button:hover{ filter: brightness(1.05); }
    button:active{ transform: translateY(1px); }

    input,textarea{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--brand-border);
      background: rgba(255,255,255,0.06);
      color: var(--brand-text);
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap }
    .row > *{ flex:1 1 200px }
    .row > button { flex: 0 0 auto; }

    code{ background: rgba(255,255,255,0.08); padding:2px 6px; border-radius:6px; color: var(--brand-cyan); }
    #output{ white-space: pre-wrap; display:none; }

    .badge{
      display:inline-block; padding:2px 8px; border-radius:999px;
      border:1px solid var(--brand-border); background: rgba(255,255,255,0.08);
      font-size: 12px; margin-right:8px;
    }

    .hero { position: relative; }
    .glow {
      position: absolute; left: 50%; top: -20px; transform: translateX(-50%);
      width: 520px; height: 180px;
      background:
        radial-gradient(closest-side, var(--brand-accent), transparent 60%),
        radial-gradient(closest-side, var(--brand-cyan),   transparent 65%);
      filter: blur(40px); opacity: .35; pointer-events: none; z-index: 0;
    }
  </style>
</head>
<body>

  <div class="hero">
    <div class="glow"></div>
    <header style="display:flex;align-items:center;gap:12px;margin-bottom:16px;position:relative;z-index:1">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Harbor &amp; Vale LLC" style="height:56px;width:auto;">
      <div>
        <h1 style="margin:0">King County Survival Guide</h1>
        <p class="muted" style="margin:0">by Harbor &amp; Vale LLC</p>
      </div>
      <span class="pill" style="margin-left:auto">Demo • Tier 1–3 foundation</span>
    </header>
  </div>

  <!-- Safety & Respect (cultural competency microcopy) -->
  <div class="card" aria-label="Safety and Respect">
    <h2>Safety &amp; Respect</h2>
    <ul>
      <li>Use the name you prefer. Share only what you want—no sensitive health info needed here.</li>
      <li>Affirming resources: we note walk-ins and inclusive services when possible.</li>
      <li>Emergencies: call <strong>911</strong>. Mental health crisis: call/text <strong>988</strong>. General help: <strong>211</strong>.</li>
    </ul>
  </div>

  <!-- Quick Actions -->
  <div class="card" id="quick-actions">
    <h2>Quick Actions</h2>
    <div class="row" role="group" aria-label="Actions">
      <button onclick="loadServices()">See Nearby Services</button>
      <button onclick="triage('I need housing')">AI: I need housing</button>
      <button onclick="triage('I need medical')">AI: I need medical</button>
      <button onclick="loadServicesFiltered('Clinic')">Clinics</button>
      <button onclick="loadServicesFiltered('Shelter')">Shelters</button>
    </div>

    <!-- Search row -->
    <div class="row" style="margin-top:8px">
      <input id="q" placeholder="Search services (e.g., showers, IDs, meals, transit)" aria-label="Search services"/>
      <button onclick="loadServicesQuery()">Search</button>
      <button onclick="clearSearch()">Clear</button>
    </div>

    <!-- Filters row -->
    <div class="row" style="margin-top:8px">
      <select id="hood" aria-label="Neighborhood">
        <option value="">All neighborhoods</option>
      </select>

      <label class="pill" style="display:flex;align-items:center;gap:6px">
        <input id="walkin" type="checkbox" style="transform:translateY(1px)"> Walk-in only
      </label>

      <button onclick="applyFilters()">Apply filters</button>
      <a href="/login" style="margin-left:auto"><button type="button" aria-label="Open dashboard login">Case dashboard</button></a>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="pill" style="display:none;margin-top:8px">Loading…</div>

    <p class="muted">Demo only. Buttons may log anonymous usage to improve services. For emergencies use 911; for crisis use 988; for general resources use 211.</p>

    <!-- Results -->
    <div id="cards"></div>
    <pre id="output" class="card"></pre>
  </div>

  <!-- Intake -->
  <div class="card">
    <h2>Contact / Intake (Demo)</h2>
    <form id="demoForm" onsubmit="submitForm(event)" aria-label="Intake form">
      <div class="row">
        <input name="name" placeholder="Your preferred name (optional)" aria-label="Preferred name"/>
        <input name="need" placeholder="What do you need? (e.g., housing, ID, meal)" aria-label="Your need"/>
      </div>
      <textarea name="details" rows="3" placeholder="Add any details you want to share (optional)" aria-label="Details"></textarea>
      <div style="margin-top:12px">
        <button type="submit">Submit</button>
      </div>
    </form>
    <p class="muted">We don’t collect sensitive health information here. Submit shares a demo intake to the case dashboard queue.</p>
  </div>

  <footer class="muted" style="margin-top:28px;font-size:12px">
    © Harbor &amp; Vale LLC — demo only. No PHI; call 211 for general resources, 911 for emergencies, and 988 for mental health crises.
    <br/>Not affiliated with King County government.
    <br/>Contact: <a href="mailto:info@harborandvale.com">info@harborandvale.com</a>
  </footer>

<script>
  // Debug output helper (shows the hidden box when needed)
  const out = (data) => {
    const el = document.getElementById('output');
    if (el) { el.style.display = 'block'; el.textContent = JSON.stringify(data, null, 2); }
  };

  // Show any JS errors in the output box
  window.onerror = function(msg, src, line, col, err){
    out({ js_error: String(msg), src, line, col, stack: err && err.stack });
    return false;
  };

  // Loading pill toggler
  function setLoading(on, msg){
    const el = document.getElementById('loading');
    if (!el) return;
    el.style.display = on ? 'inline-block' : 'none';
    el.textContent = msg || 'Loading…';
  }

  // Track anonymous events (Tier 3)
  async function track(type, name, meta){
    try{
      await fetch('/event', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ type, name, meta })
      });
    }catch(_){/* non-fatal */}
  }

  // Render result cards with badges and actions
  function renderCards(list){
    const el = document.getElementById('cards');
    if (!el) { out({error:"Missing #cards container"}); return; }
    if (!Array.isArray(list)) { out({error:"Expected array", got: typeof list}); return; }

    el.innerHTML = list.map(s => {
      const maps = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.address || s.name)}`;
      const tel  = s.phone ? `tel:${s.phone.replace(/[^+\d]/g,'')}` : null;
      const walk = s.walk_in ? `<span class="badge">Walk-in</span>` : ``;
      const hours = s.hours ? `<span class="badge">${s.hours}</span>` : ``;
      const safeName = (s.name || '').replace(/'/g, "\\'");
      const addrJS = (s.address || '').replace(/'/g, "\\'");
      return `
        <div class="card">
          <div style="margin-bottom:6px">${walk}${hours}</div>
          <h3 style="margin:0 0 4px 0">${s.name}</h3>
          <p class="muted">${s.type || ''} • ${s.neighborhood || 'Seattle'}</p>
          ${s.notes ? `<p>${s.notes}</p>` : ''}
          <div class="row" style="margin-top:8px">
            ${tel ? `<a href="${tel}" onclick="track('call_click','${safeName}',{})"><button aria-label="Call ${safeName}">Call</button></a>` : ''}
            ${s.website ? `<a target="_blank" rel="noopener" href="${s.website}" onclick="track('website_click','${safeName}',{})"><button aria-label="Open website for ${safeName}">Website</button></a>` : ''}
            <a target="_blank" rel="noopener" href="${maps}" onclick="track('directions_click','${safeName}',{})"><button aria-label="Directions to ${safeName}">Directions</button></a>
            ${s.address ? `<button onclick="copyAddr('${addrJS}','${safeName}')">Copy address</button>` : ''}
          </div>
        </div>
      `;
    }).join('');
  }

  function copyAddr(addr, name){
    try{
      navigator.clipboard.writeText(addr);
      setLoading(true, 'Address copied'); setTimeout(()=>setLoading(false), 700);
      track('copy_address', name, {});
    }catch(e){
      out({error:'Clipboard failed', detail:String(e)});
    }
  }

  // Load all services
  async function loadServices(){
    setLoading(true, 'Loading services…');
    try{
      const res = await fetch('/services', { cache: 'no-store' });
      const data = await res.json();
      renderCards(data);
      track('filter', 'all', {});
    }catch(e){
      out({ error: String(e) });
    }finally{
      setLoading(false);
    }
  }

  // Filter by type, with retry for hobby-tier hiccups
  async function loadServicesFiltered(kind){
    setLoading(true, `Filtering: ${kind}`);
    try{
      let res = await fetch('/services?type=' + encodeURIComponent(kind), { cache: 'no-store' });
      if (!res.ok) {
        await new Promise(r => setTimeout(r, 600));
        res = await fetch('/services?type=' + encodeURIComponent(kind), { cache: 'no-store' });
      }
      const txt = await res.text();
      try { renderCards(JSON.parse(txt)); track('filter', kind, {}); }
      catch (parseErr) { out({ error: 'Failed to parse JSON', status: res.status, raw: txt.slice(0, 400) }); }
    }catch(e){
      out({ error: String(e) });
    }finally{
      setLoading(false);
    }
  }

  // Keyword search (server handles synonyms)
  async function loadServicesQuery(){
    const term = (document.getElementById('q')?.value || '').trim();
    setLoading(true, term ? `Searching: ${term}` : 'Loading services…');
    try{
      const url = term ? ('/services?q=' + encodeURIComponent(term)) : '/services';
      let res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) {
        await new Promise(r => setTimeout(r, 600));
        res = await fetch(url, { cache: 'no-store' });
      }
      const txt = await res.text();
      try { renderCards(JSON.parse(txt)); track('search', term || 'all', {}); }
      catch (parseErr) { out({ error: 'Failed to parse JSON', status: res.status, raw: txt.slice(0, 400) }); }
    }catch(e){
      out({ error: String(e) });
    }finally{
      setLoading(false);
    }
  }

  function clearSearch(){
    const inp = document.getElementById('q'); if (inp) inp.value = '';
    document.getElementById('cards').innerHTML = '';
    document.getElementById('output').style.display = 'none';
  }

  // AI triage (with event logging)
  async function triage(message){
    setLoading(true, 'Thinking…');
    try{
      const res = await fetch('/ai_triage', {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ message })
      });
      const txt = await res.text();
      try { out(JSON.parse(txt)); /* server logs event */ }
      catch (parseErr) { out({ error: String(parseErr), status: res.status, raw: txt.slice(0, 300) }); }
    } catch(e){
      out({ error: String(e) });
    } finally {
      setLoading(false);
    }
  }

  // Apply Neighborhood + Walk-in filters
  async function applyFilters(){
    const hood = (document.getElementById('hood')?.value || '').trim();
    const walk = document.getElementById('walkin')?.checked ? 'true' : '';
    let url = '/services';
    const params = [];
    if (hood) params.push('neighborhood=' + encodeURIComponent(hood));
    if (walk) params.push('walk_in=true');
    if (params.length) url += '?' + params.join('&');

    setLoading(true, params.length ? 'Applying filters…' : 'Loading services…');
    try{
      let res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) {
        await new Promise(r => setTimeout(r, 600));
        res = await fetch(url, { cache: 'no-store' });
      }
      const txt = await res.text();
      try { renderCards(JSON.parse(txt)); track('filter', params.join('&') || 'all', {}); }
      catch (parseErr) { out({ error: 'Failed to parse JSON', status: res.status, raw: txt.slice(0, 400) }); }
    }catch(e){
      out({ error: String(e) });
    }finally{
      setLoading(false);
    }
  }

  // Populate Neighborhood dropdown on load
  async function populateNeighborhoods(){
    try{
      const select = document.getElementById('hood');
      if (!select) return;
      const res = await fetch('/services', { cache: 'no-store' });
      const data = await res.json();
      const uniq = Array.from(new Set((data || []).map(s => s.neighborhood).filter(Boolean))).sort();
      const opts = uniq.map(n => `<option value="${n}">${n}</option>`).join('');
      const first = '<option value="">All neighborhoods</option>';
      select.innerHTML = first + opts;
    }catch(e){ /* non-fatal */ }
  }
  document.addEventListener('DOMContentLoaded', populateNeighborhoods);

  // Demo form submit
  async function submitForm(e){
    e.preventDefault();
    const form = new FormData(document.getElementById('demoForm'));
    const res = await fetch('/submit_form',{ method:'POST', body: form });
    const data = await res.json();
    out(data);
  }

  // Enter submits search
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && document.activeElement?.id === 'q') {
      e.preventDefault();
      loadServicesQuery();
    }
  });
</script>
</body>
</html>
