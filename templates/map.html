<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Map – King County Survival Guide</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;color:#111}
    #map{height: calc(100vh - 56px)}
    header{padding:8px 12px;border-bottom:1px solid #eee;display:flex;gap:8px;align-items:center}
    select,button{padding:8px;border-radius:8px;border:1px solid #ccc}
  </style>
</head>
<body>
  <header>
    <strong>Map – King County Survival Guide</strong>
    <select id="type"><option value="">All types</option><option>Shelter</option><option>Clinic</option><option>Day Center</option><option>Food Bank</option><option>Detox</option></select>
    <label><input id="walk" type="checkbox"> Walk-in</label>
    <button onclick="apply()">Apply</button>
    <button onclick="useMyLocation()">Use my location</button>
    <a href="/"><button type="button">Home</button></a>
  </header>
  <div id="map"></div>
<script>
  let map=L.map('map').setView([47.6062,-122.3321], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
  let markers=[];

  function clearMarkers(){ markers.forEach(m=>m.remove()); markers=[]; }
  function addMarker(s){
    if(!(s.lat && s.lng)) return; // skip if no coords
    const m=L.marker([s.lat, s.lng]).addTo(map);
    m.bindPopup(`<strong>${s.name}</strong><br>${s.type||''} • ${s.neighborhood||''}<br>
      <a href="/s/${s.slug}">Details</a> · <a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.address||s.name)}">Directions</a>`);
    markers.push(m);
  }

  async function load(url){
    const res=await fetch(url); const data=await res.json();
    clearMarkers(); data.forEach(addMarker);
    if(data[0]?.lat && data[0]?.lng) map.setView([data[0].lat,data[0].lng], 12);
  }

  function apply(){
    const p=[]; const t=document.getElementById('type').value; if(t) p.push('type='+encodeURIComponent(t));
    if(document.getElementById('walk').checked) p.push('walk_in=true');
    load('/services'+(p.length?('?'+p.join('&')):'')); 
  }

  function useMyLocation(){
    if(!navigator.geolocation) return alert('Location not available');
    navigator.geolocation.getCurrentPosition(pos=>{
      map.setView([pos.coords.latitude,pos.coords.longitude], 13);
    },()=>alert('Could not access location'));
  }

  load('/services');
</script>
</body>
</html>
